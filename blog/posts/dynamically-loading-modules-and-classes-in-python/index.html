<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>LexToumbourou.com - Dynamically loading modules and classes in Python</title>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//yandex.st/highlightjs/7.3/styles/github.min.css">
    <link rel="alternate" type="application/atom+xml" title="LexToumbourou.com" href="http://lextoumbourou.github.io/atom.xml">

      <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
      <!--[if lt IE 8]>
        <link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection">
      <![endif]-->
      <script type="text/javascript" src="/theme/js/app.js"></script>
    <noscript>
      <style>
        div.article_body {
          opacity: 1;
        }
        ul.articles {
          opacity: 1;
        }
      </style>
    </noscript>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33772243-5', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="container">

      <div id="header">
        <div id="side-header">
          <a href="/pages/about.html"><img src="https://avatars1.githubusercontent.com/u/1080552?v=3&s=200" width="90" id="main-image"></a>
          <ul>
            <li><a href="https://github.com/lextoumbourou"><i class="fa fa-github fa-1x"></i></a></li>
            <li><a href="https://twitter.com/lexandstuff"><i class="fa fa-twitter fa-1x"></i></a></li>
            <li><a href="https://www.instagram.com/lextoumbourou/"><i class="fa fa-instagram fa-1x"></i></a></li>
            <li><a href="https://au.linkedin.com/in/lextoumbourou"><i class="fa fa-linkedin fa-1x"></i></a></li>
            <li><a href="https://www.youtube.com/user/5footnothingmusic"><i class="fa fa-youtube fa-1x"></i></a></li>
          </ul>
        </div>

        <h1><a href="/">Lex Toumbourou</a></h1>

        <div id="slogan">Python, data, DevOps etc</div>

      </div>

      <hr>

      <div id="content">
<div class="articles">
    <a name="article"></a>
    <article>
        <header class="title">
            <h2>
                Oct 12, 2012.
                <a href="/blog/posts/dynamically-loading-modules-and-classes-in-python/" rel="bookmark">Dynamically loading modules and classes in Python</a>
            </h2>
        </div>

        <div class="article_body">
            </p>

<div class="intro">
There was once a time, I remember, many, many minutes ago, where I
wished to implement a rudimentary plugin engine for a little
application. In it, there would be a plugin directory where Python
modules could be copied and then dynamically loaded on application
start.
</div>

<h3>The setup</h3>
<p>The expectations for plugins would be that the class's name matches the
file's name, PascalCased after removing the <em>plugin_</em> prefix. For
example, for module <em>plugin_do_something.py</em>, the class name will be
<em>DoSomething()</em>. So, the setup should look something like this:</p>
<div class="highlight"><pre>lex@server:~/my_app&gt; ls -l plugins/
total 3
-rw-r--r-- 1 lex lex   0 Oct 11 13:35 __init__.py
-rw-r--r-- 1 lex lex  55 Oct 11 13:47 plugin_test.py
-rw-r--r-- 1 lex lex  57 Oct 11 13:47 plugin_test_2.py
lex@server:~/my_app&gt; cat plugins/plugin_test.py
class Test<span class="o">()</span>:
    def run<span class="o">(</span>self<span class="o">)</span>:
        print <span class="s2">&quot;Inside the Test class!&quot;</span>
lex@server:~/my_app&gt; cat plugins/plugin_test_2.py
class Test2<span class="o">()</span>:
    def run<span class="o">(</span>self<span class="o">)</span>:
        print <span class="s2">&quot;Inside the Test2 class!&quot;</span>
</pre></div>


<h3>Iterating through modules for fun and profit</h3>
<p>The <a href="http://docs.python.org/library/pkgutil.html">pkgutil</a> package includes a function called <em>iter_modules</em>,
which allows for iterating through a list of modules in a package
(usually, a directory with a <em>__init__.py</em> file in it.)</p>
<p><em>iter_modules</em> takes in a list of paths (and, additionally, a prefix to
append to each module) and yields a list of tuples containing a
<a href="http://www.python.org/dev/peps/pep-0302/">loader</a>, the module name and an <em>ispkg</em> bool. So, your code could
look something like this:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="n">modules</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plugins&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">loader</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">ispkg</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span> 
    <span class="k">print</span> <span class="n">mod_name</span>
</pre></div>


<p>Which should run something like this:</p>
<div class="highlight"><pre>lex@server:~/my_app&gt; python dynamic_loader.py
plugin_test
plugin_test_2
</pre></div>


<h3>Determining the class name</h3>
<p>Now that I have the module names, I can determine the class names. Since
we know the format the class should be in, we can get the class name
with a function like this:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_class_name</span><span class="p">(</span><span class="n">mod_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the class name from a plugin name&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="c"># Split on the _ and ignore the 1st word plugin</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">mod_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Capitalise the first letter of each word and add to string</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">word</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>


<h3>Importing the modules and instantiating the classes</h3>
<p>Utilising the [__import__][] function, whose purpose is to "import a
module whose name is only known at runtime", we can dynamically load the
module. Then, we can call the <a href="http://docs.python.org/library/functions.html#getattr">getattr</a> function to create a reference
to a class, which we use to instantiate an instance. In other words,
this:</p>
<div class="highlight"><pre><span class="n">loaded_mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">mod_name</span><span class="p">])</span>
<span class="c"># Get the class&#39;s name</span>
<span class="n">class_name</span> <span class="o">=</span> <span class="n">get_class_name</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>

<span class="c"># Load it from imported module</span>
<span class="n">loaded_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">loaded_mod</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

<span class="c"># Create an instance of it</span>
<span class="n">instance</span> <span class="o">=</span> <span class="n">loaded_class</span><span class="p">()</span>
</pre></div>


<h3>Putting it all together</h3>
<p>Finally, we put it all together and call the <em>run()</em> method that I
specified in each class.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">get_class_name</span><span class="p">(</span><span class="n">mod_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the class name from a plugin name&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="c"># Split on the _ and ignore the 1st word plugin</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">mod_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c"># Capitalise the first letter of each word and add to string</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">word</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;plugins&quot;</span><span class="p">)</span>
<span class="n">modules</span> <span class="o">=</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="p">[</span><span class="n">path</span><span class="p">])</span>

<span class="k">for</span> <span class="n">loader</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">ispkg</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
    <span class="c"># Ensure that module isn&#39;t already loaded</span>
    <span class="k">if</span> <span class="n">mod_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="c"># Import module</span>
        <span class="n">loaded_mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">mod_name</span><span class="p">])</span>

        <span class="c"># Load class from imported module</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">get_class_name</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
        <span class="n">loaded_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">loaded_mod</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="c"># Create an instance of the class</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">loaded_class</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p>And, now to profit.</p>
<div class="highlight"><pre>lex@server:~/my_app&gt; python dynamic_loader.py
Inside the Test class!
Inside the Test2 class!
</pre></div>


<h3>Following me on Twitter</h3>
<p>While you're here, you might as well follow me on <a href="http://twitter.com/lexandstuff">Twitter</a>.</p>
        </div>
    </article>

<div class="twitter-link">
    <a href="https://twitter.com/lexandstuff">&#x2764;</a>
</div>

</div>
<div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lextoumbouroucom'; // Required - Replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a></div>
        <hr>
      </div>

    </div>
    <script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>