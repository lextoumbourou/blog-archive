<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>LexToumbourou.com - Packet capturing in parallel with Ansible</title>
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//yandex.st/highlightjs/7.3/styles/github.min.css">
    <link rel="alternate" type="application/atom+xml" title="LexToumbourou.com" href="http://lextoumbourou.github.io/atom.xml">

      <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
      <!--[if lt IE 8]>
        <link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection">
      <![endif]-->
      <script type="text/javascript" src="/theme/js/app.js"></script>
    <noscript>
      <style>
        div.article_body {
          opacity: 1;
        }
        ul.articles {
          opacity: 1;
        }
      </style>
    </noscript>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33772243-5', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="container">

      <div id="header">
        <div id="side-header">
          <a href="/pages/about.html"><img src="https://avatars1.githubusercontent.com/u/1080552?v=3&s=200" width="90" id="main-image"></a>
          <ul>
            <li><a href="https://github.com/lextoumbourou"><i class="fa fa-github fa-1x"></i></a></li>
            <li><a href="https://twitter.com/lexandstuff"><i class="fa fa-twitter fa-1x"></i></a></li>
            <li><a href="https://www.instagram.com/lextoumbourou/"><i class="fa fa-instagram fa-1x"></i></a></li>
            <li><a href="https://au.linkedin.com/in/lextoumbourou"><i class="fa fa-linkedin fa-1x"></i></a></li>
            <li><a href="https://www.youtube.com/user/5footnothingmusic"><i class="fa fa-youtube fa-1x"></i></a></li>
          </ul>
        </div>

        <h1><a href="/">Lex Toumbourou</a></h1>

        <div id="slogan">Python, data, DevOps etc</div>

      </div>

      <hr>

      <div id="content">
<div class="articles">
    <a name="article"></a>
    <article>
        <header class="title">
            <h2>
                Aug 13, 2013.
                <a href="/blog/posts/packet-capturing-in-parallel-ansible/" rel="bookmark">Packet capturing in parallel with Ansible</a>
            </h2>
        </div>

        <div class="article_body">
            <p><a name="intro"></a></p>
<div class="intro">
Ansible continues to amaze me. It seems to be able to solve so many
problems with such simplicity and I keep finding new uses for it. Enter
today's problem and solution.
</div>

<h3>The Problem</h3>
<ul>
<li>Run Tcpdump for a short window in parallel across a massive test
    environment while front-end tests are performed</li>
<li>Gzip and tar each generated pcap and copy to a remote share for
    distribution</li>
</ul>
<p>After getting my environment setup right, the solution took me a total
of 30 minutes to write and deploy. Plus, it is completely reusable in
any environment (though the interface parameter passed to tcpdump may
require tweaking).</p>
<h3>The Solution</h3>
<p>1. First I utilised Ansible's host variables to create a unique file
name for each server.</p>
<div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">cap_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">packet_capture_{{ ansible_hostname }}_{{ ansible_date_time[&#39;epoch&#39;] }}.cap</span>
</pre></div>


<p>2. Then I kicked off a Tcpdump on each server in parallel. Ansible
runs 5 parallel processes by default, this can be increased by passing
the <code>--forks=10</code> parameter (replacing 10 with the number of servers) to the <code>ansible-playbook</code> script.</p>
<div class="highlight"><pre>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start tcpdump</span>
       <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/sbin/tcpdump -i eth0 -s 0 -w /tmp/${cap_file}</span>
       <span class="l-Scalar-Plain">async</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60</span>
       <span class="l-Scalar-Plain">poll</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</pre></div>


<p>As well as running Playbooks against servers in parallel, tasks can be
run asynchronously by setting the <code>async</code> (maximum runtime) and <code>poll</code>
(how often to poll the job for status). In this example, I'm using
Ansible's <a href="http://www.ansibleworks.com/docs/playbooks2.html#id19">fire-and-forget</a> pattern to run the command without
pausing, allowing me to kill it later on in the Playbook.</p>
<p>3. Next the script is <a href="http://www.ansibleworks.com/docs/modules.html#pause">paused</a> for a minute allowing the testers to
run through their failing tests.</p>
<div class="highlight"><pre>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pause</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">minutes=1 prompt=&quot;pause for 60 seconds or press Ctrl + c then c to continue&quot;</span>
</pre></div>


<p>4. Then I kill off the tcpdump command with pkill.</p>
<div class="highlight"><pre>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kill tcpdump</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/bin/pkill tcpdump</span>
      <span class="l-Scalar-Plain">ignore_errors</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</pre></div>


<p>5. Lastly, I can compress the logs and copy them to my localhost using
the <a href="http://www.ansibleworks.com/docs/modules.html#fetch">fetch</a> module. The <code>flat</code> parameter copies up each file
individually. Without it, the files are stored in a
<code>${server_name}/{$path}/file</code> directory structure, ensuring files with
the same name don't overwrite each other.</p>
<div class="highlight"><pre>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">compress capture file</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gzip ${cap_file} chdir=/tmp</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">copy logs to local boxes webroot</span>
      <span class="l-Scalar-Plain">fetch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=/tmp/${cap_file}.gz dest=/var/www/ flat=yes</span>
</pre></div>


<p>It's probably a good idea to clean up the files on the remote server
too.</p>
<div class="highlight"><pre>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">remove files from server</span>
      <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/tmp/${cap_file}.gz state=absent</span>
</pre></div>


<p>6. Now I run it from the command line...</p>
<div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span>&gt; ansible-playbook parallel-tcpdump.yml -i hosts
</pre></div>


<p>And like magic:</p>
<div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span>&gt; ls -1 /var/www/ | grep packet_capture
packet_capture_server1_1376450197.cap.gz
packet_capture_server2_1376450500.cap.gz
packet_capture_server3_1376451234.cap.gz
</pre></div>


<p>Here's the entire Playbook:</p>
<script src="https://gist.github.com/lextoumbourou/7611499.js"></script>
        </div>
    </article>

<div class="twitter-link">
    <a href="https://twitter.com/lexandstuff">&#x2764;</a>
</div>

</div>
<div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lextoumbouroucom'; // Required - Replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a></div>
        <hr>
      </div>

    </div>
    <script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>